import json
import os
from datetime import datetime
from gerar_token import GerenciadorTokens

class RelatorioTokens:
    def __init__(self):
        self.gt = GerenciadorTokens()
        self.arquivo_tokens = 'tokens.json'
        self.arquivo_logs = 'logs_acesso.json'
    
    def mostrar_relatorio_completo(self):
        """Mostra relat√≥rio detalhado de todos os tokens"""
        try:
            with open(self.arquivo_tokens, 'r', encoding='utf-8') as f:
                tokens = json.load(f)
            
            if not tokens:
                print("üì≠ Nenhum token encontrado.")
                return
            
            # Contadores
            ativos = 0
            expirados = 0
            inativos = 0
            nunca_acessaram = 0
            total_downloads = 0
            
            print("\n" + "="*80)
            print("üìä RELAT√ìRIO COMPLETO DE TOKENS - GABRIEL LIMA RETRATOS")
            print("="*80)
            
            for token, dados in tokens.items():
                expira = datetime.fromisoformat(dados['expira_em'])
                agora = datetime.now()
                
                # Determina status
                if not dados['ativo']:
                    status = "üî¥ INATIVO"
                    inativos += 1
                elif expira < agora:
                    status = "‚ö†Ô∏è  EXPIRADO"
                    expirados += 1
                else:
                    dias_restantes = (expira - agora).days
                    status = f"üü¢ ATIVO ({dias_restantes}d)"
                    ativos += 1
                
                # Verifica se nunca acessou
                if not dados['acessos']:
                    nunca_acessaram += 1
                
                # Conta downloads
                total_downloads += len(dados['fotos_baixadas'])
                
                # √öltimo acesso
                ultimo_acesso = "Nunca"
                if dados['acessos']:
                    ultimo_dt = datetime.fromisoformat(dados['acessos'][-1])
                    ultimo_acesso = ultimo_dt.strftime('%d/%m/%Y √†s %H:%M')
                
                print(f"\nüë§ {dados['cliente']}")
                print(f"   üîë Token: {token}")
                print(f"   üìä Status: {status}")
                print(f"   üìÇ {dados['categoria']} ‚Üí {dados['pasta']}")
                print(f"   üìÖ Criado em: {datetime.fromisoformat(dados['criado_em']).strftime('%d/%m/%Y')}")
                print(f"   üïí √öltimo acesso: {ultimo_acesso}")
                print(f"   üîó Total de acessos: {len(dados['acessos'])}")
                print(f"   üíæ Fotos baixadas: {len(dados['fotos_baixadas'])}")
                print("-" * 80)
            
            # Resumo final
            print("\n" + "="*80)
            print("üìà RESUMO ESTAT√çSTICO")
            print("="*80)
            print(f"üìä Total de tokens: {len(tokens)}")
            print(f"üü¢ Tokens ativos: {ativos}")
            print(f"‚ö†Ô∏è  Tokens expirados: {expirados}")
            print(f"üî¥ Tokens inativos: {inativos}")
            print(f"üëª Nunca acessaram: {nunca_acessaram}")
            print(f"üíæ Total de downloads: {total_downloads}")
            print("="*80)
            
        except Exception as e:
            print(f"‚ùå Erro ao gerar relat√≥rio: {e}")
    
    def clientes_nunca_acessaram(self):
        """Lista clientes que nunca acessaram"""
        try:
            with open(self.arquivo_tokens, 'r', encoding='utf-8') as f:
                tokens = json.load(f)
            
            nunca_acessaram = []
            
            for token, dados in tokens.items():
                if not dados['acessos'] and dados['ativo']:
                    nunca_acessaram.append((token, dados))
            
            if not nunca_acessaram:
                print("‚úÖ Todos os clientes ativos j√° acessaram!")
                return
            
            print("\n" + "="*60)
            print("üëª CLIENTES QUE NUNCA ACESSARAM")
            print("="*60)
            
            for token, dados in nunca_acessaram:
                dias_desde_criacao = (datetime.now() - datetime.fromisoformat(dados['criado_em'])).days
                print(f"\nüë§ {dados['cliente']}")
                print(f"   üîë Token: {token}")
                print(f"   üìÇ {dados['categoria']}")
                print(f"   üìÖ Criado h√° {dias_desde_criacao} dias")
                print(f"   üì± Link: https://seusite.github.io/galeria?token={token}")
            
            print("="*60)
            
        except Exception as e:
            print(f"‚ùå Erro ao listar clientes: {e}")
    
    def tokens_expirando(self, dias=7):
        """Lista tokens que v√£o expirar em X dias"""
        try:
            with open(self.arquivo_tokens, 'r', encoding='utf-8') as f:
                tokens = json.load(f)
            
            expirando = []
            agora = datetime.now()
            
            for token, dados in tokens.items():
                if not dados['ativo']:
                    continue
                    
                expira = datetime.fromisoformat(dados['expira_em'])
                dias_restantes = (expira - agora).days
                
                if 0 <= dias_restantes <= dias:
                    expirando.append((token, dados, dias_restantes))
            
            if not expirando:
                print(f"‚úÖ Nenhum token expira nos pr√≥ximos {dias} dias!")
                return
            
            print(f"\n" + "="*60)
            print(f"‚ö†Ô∏è  TOKENS EXPIRANDO EM {dias} DIAS")
            print("="*60)
            
            # Ordena por dias restantes
            expirando.sort(key=lambda x: x[2])
            
            for token, dados, dias_restantes in expirando:
                urgencia = "üö® HOJE!" if dias_restantes == 0 else f"‚è∞ {dias_restantes} dia(s)"
                
                print(f"\nüë§ {dados['cliente']}")
                print(f"   üîë Token: {token}")
                print(f"   ‚ö†Ô∏è  Expira: {urgencia}")
                print(f"   üìÇ {dados['categoria']}")
                print(f"   üîó Acessos: {len(dados['acessos'])}")
            
            print("="*60)
            
        except Exception as e:
            print(f"‚ùå Erro ao verificar expira√ß√£o: {e}")
    
    def desativar_token(self):
        """Desativa um token espec√≠fico"""
        try:
            # Primeiro mostra tokens ativos
            print("\nüìã TOKENS ATIVOS:")
            self.listar_tokens_ativos()
            
            token = input("\nüîë Digite o token para desativar: ").strip()
            
            with open(self.arquivo_tokens, 'r', encoding='utf-8') as f:
                tokens = json.load(f)
            
            if token not in tokens:
                print("‚ùå Token n√£o encontrado!")
                return
            
            if not tokens[token]['ativo']:
                print("‚ö†Ô∏è  Token j√° est√° inativo!")
                return
            
            # Confirma desativa√ß√£o
            cliente = tokens[token]['cliente']
            confirma = input(f"‚ùì Desativar token do cliente '{cliente}'? (s/N): ").strip().lower()
            
            if confirma == 's':
                tokens[token]['ativo'] = False
                tokens[token]['desativado_em'] = datetime.now().isoformat()
                
                with open(self.arquivo_tokens, 'w', encoding='utf-8') as f:
                    json.dump(tokens, f, indent=2, ensure_ascii=False)
                
                # Faz backup
                self.gt.fazer_backup()
                
                print(f"‚úÖ Token do cliente '{cliente}' foi desativado!")
            else:
                print("‚ùå Opera√ß√£o cancelada.")
                
        except Exception as e:
            print(f"‚ùå Erro ao desativar token: {e}")
    
    def listar_tokens_ativos(self):
        """Lista apenas tokens ativos"""
        try:
            with open(self.arquivo_tokens, 'r', encoding='utf-8') as f:
                tokens = json.load(f)
            
            ativos = []
            agora = datetime.now()
            
            for token, dados in tokens.items():
                if dados['ativo']:
                    expira = datetime.fromisoformat(dados['expira_em'])
                    if expira > agora:  # N√£o expirado
                        ativos.append((token, dados))
            
            if not ativos:
                print("üì≠ Nenhum token ativo encontrado.")
                return
            
            for token, dados in ativos:
                expira = datetime.fromisoformat(dados['expira_em'])
                dias_restantes = (expira - agora).days
                
                print(f"üë§ {dados['cliente']} | Token: {token[:8]}... | {dias_restantes} dias restantes")
                
        except Exception as e:
            print(f"‚ùå Erro ao listar tokens ativos: {e}")
    
    def estatisticas_categoria(self):
        """Mostra estat√≠sticas por categoria"""
        try:
            with open(self.arquivo_tokens, 'r', encoding='utf-8') as f:
                tokens = json.load(f)
            
            stats = {}
            
            for token, dados in tokens.items():
                categoria = dados['categoria']
                if categoria not in stats:
                    stats[categoria] = {
                        'total': 0,
                        'ativos': 0,
                        'downloads': 0,
                        'acessos': 0
                    }
                
                stats[categoria]['total'] += 1
                if dados['ativo']:
                    stats[categoria]['ativos'] += 1
                stats[categoria]['downloads'] += len(dados['fotos_baixadas'])
                stats[categoria]['acessos'] += len(dados['acessos'])
            
            print("\n" + "="*60)
            print("üìä ESTAT√çSTICAS POR CATEGORIA")
            print("="*60)
            
            for categoria, dados in stats.items():
                print(f"\nüìÇ {categoria}")
                print(f"   üìä Total de clientes: {dados['total']}")
                print(f"   üü¢ Ativos: {dados['ativos']}")
                print(f"   üîó Total de acessos: {dados['acessos']}")
                print(f"   üíæ Total de downloads: {dados['downloads']}")
            
            print("="*60)
            
        except Exception as e:
            print(f"‚ùå Erro ao gerar estat√≠sticas: {e}")

def main():
    """Menu principal do relat√≥rio"""
    rt = RelatorioTokens()
    
    while True:
        print("\n" + "="*50)
        print("üìä RELAT√ìRIOS - GABRIEL LIMA RETRATOS")
        print("="*50)
        print("1. üìã Relat√≥rio completo")
        print("2. üëª Clientes que nunca acessaram")
        print("3. ‚ö†Ô∏è  Tokens expirando (7 dias)")
        print("4. ‚ùå Desativar token")
        print("5. üü¢ Listar apenas ativos")
        print("6. üìä Estat√≠sticas por categoria")
        print("7. üö™ Voltar")
        
        opcao = input("\nEscolha uma op√ß√£o: ").strip()
        
        if opcao == "1":
            rt.mostrar_relatorio_completo()
        elif opcao == "2":
            rt.clientes_nunca_acessaram()
        elif opcao == "3":
            rt.tokens_expirando()
        elif opcao == "4":
            rt.desativar_token()
        elif opcao == "5":
            rt.listar_tokens_ativos()
        elif opcao == "6":
            rt.estatisticas_categoria()
        elif opcao == "7":
            break
        else:
            print("‚ùå Op√ß√£o inv√°lida!")
        
        input("\n‚è∏Ô∏è  Pressione ENTER para continuar...")

if __name__ == "__main__":
    main()